# Быстрый старт: Интерьеры (MLO)

## 📋 Описание

Модуль интерьеров позволяет управлять MLO (Multi-Level Objects) - интерьерами из GTA V. Система автоматически обнаруживает интерьеры в архивах при их индексации.

---

## 🚀 Использование

### 1. Просмотр интерьеров

1. Откройте панель MeshHub (F10)
2. Перейдите на вкладку "Интерьеры"
3. Выберите источник:
   - **HUB** - интерьеры с сервера hub.feeld.space
   - **GTAV** - базовые интерьеры GTA V (скоро)
   - **Local** - установленные локально интерьеры (скоро)

### 2. Установка интерьера

1. Нажмите кнопку "Скачать" на нужном интерьере
2. Дождитесь завершения установки (статус изменится на "Установлен")
3. Интерьер будет установлен в папку `hubresource/interiors/`

### 3. Просмотр локаций интерьера

1. Нажмите на карточку интерьера для раскрытия
2. Вы увидите список всех локаций (позиций) интерьера
3. Каждая локация показывает:
   - Название archetype
   - Координаты X, Y, Z
   - Категорию (если определена)

### 4. Телепортация к интерьеру

1. Раскройте детали интерьера
2. Нажмите на иконку телепорта (📍) рядом с нужной локацией
3. Вы будете перемещены к интерьеру

---

## 🔧 Автоматическое обнаружение

Система автоматически обнаруживает интерьеры при индексации архивов:

1. **При загрузке архива** - система сканирует YMAP файлы
2. **Поиск CMloInstanceDef** - определяет объекты типа `CMloInstanceDef`
3. **Сохранение данных** - сохраняет позиции и метаданные в БД
4. **Обновление статуса** - помечает архив как содержащий интерьеры

### Что извлекается из YMAP:

```xml
<Item type="CMloInstanceDef">
  <archetypeName>baze_int_dealership_echelon_col</archetypeName>
  <position x="1680.5336" y="3588.8337" z="39.76234" />
  <rotation x="0" y="0" z="0" w="1" />
  <lodDist value="200" />
  <guid value="930630" />
  <flags value="1572864" />
</Item>
```

Извлекаются поля:
- `archetypeName` - название интерьера
- `position` - координаты X, Y, Z
- `rotation` - ротация (кватернион)
- `lodDist` - дистанция LOD
- `guid` - уникальный идентификатор
- `flags` - флаги объекта

---

## 📡 API Endpoints

### Backend (Go)

- `GET /api/rpf/mlo` - Список архивов с интерьерами
- `GET /api/rpf/mlo/{id}` - Детали интерьера (архива)
- `POST /api/rpf/mlo/{id}/scan` - Запустить сканирование архива
- `GET /api/rpf/mlo/stats` - Статистика по интерьерам

### Пример ответа API:

```json
{
  "success": true,
  "interiors": [
    {
      "id": "uuid",
      "name": "baze_dealership",
      "displayName": "Baze Dealership",
      "resourceType": "mlo",
      "size": 15728640,
      "interiorCount": 1,
      "interiors": [
        {
          "id": "uuid",
          "archetypeName": "baze_int_dealership_echelon_col",
          "position": {
            "x": 1680.5336,
            "y": 3588.8337,
            "z": 39.76234
          },
          "rotation": {
            "x": 0,
            "y": 0,
            "z": 0,
            "w": 1
          },
          "lodDist": 200,
          "category": "shop"
        }
      ]
    }
  ],
  "total": 1
}
```

---

## 🎮 ALT:V События

### WebView → Client

- `meshhub:interior:download` - Скачать интерьер
- `meshhub:interior:teleport` - Телепортироваться к интерьеру
- `meshhub:interior:check` - Проверить установку
- `meshhub:interior:list:request` - Запросить список установленных

### Client → WebView

- `meshhub:interior:download:response` - Ответ на скачивание
- `meshhub:interior:check:response` - Ответ на проверку
- `meshhub:interior:list:response` - Список установленных интерьеров

### Client → Server

- `meshhub:interior:download` - Запрос на скачивание (пересылается на сервер)

### Server → Client

- `meshhub:interior:download:server:response` - Ответ после скачивания

---

## 📁 Структура хранения

```
altv-server/
└── hubresource/
    └── interiors/
        ├── baze_dealership/
        │   └── dlc.rpf
        ├── apartment_complex/
        │   └── dlc.rpf
        └── warehouse_interior/
            └── dlc.rpf
```

---

## 🔍 Категоризация интерьеров

Система автоматически определяет категорию интерьера по названию archetype:

| Категория | Ключевые слова | Теги |
|-----------|----------------|------|
| Shop | shop, store, dealership | commercial |
| Warehouse | warehouse, storage | industrial |
| Office | office, building | business |
| Residential | house, apartment, condo | housing |
| Garage | garage, parking | vehicle |
| Entertainment | club, bar, casino | nightlife |
| Other | все остальные | - |

---

## ⚠️ Переиндексация архивов

**После обновления backend потребуется переиндексация:**

### Вариант 1: Через UI (rpf-frontend)

1. Откройте `http://hub.feeld.space`
2. Перейдите в "Массовая обработка"
3. Запустите переиндексацию с опциями:
   - ✅ Convert to XML
   - ✅ Index Content
   - ✅ Force Reindex

### Вариант 2: Через API

```bash
POST https://hub.feeld.space/api/rpf/archives/{id}/reindex
```

### Вариант 3: Автоматическая (при новых архивах)

Новые архивы будут автоматически сканироваться на интерьеры при индексации.

---

## 💾 База данных

### Новые таблицы:

#### `rpf_interiors`
Хранит информацию об интерьерах, извлеченных из YMAP файлов.

#### Новые поля в `rpf_archives`:
- `has_interior` (BOOLEAN) - содержит ли архив интерьеры
- `interior_count` (INTEGER) - количество интерьеров
- `interior_metadata` (JSONB) - дополнительные метаданные

### Представления:

- `rpf_interiors_with_archive` - интерьеры с информацией об архиве

---

## 🐛 Траблшутинг

### Интерьеры не отображаются

1. Проверьте, что архивы проиндексированы
2. Убедитесь, что YMAP файлы конвертированы в XML
3. Проверьте логи backend на наличие ошибок парсинга

### Телепортация не работает

1. Убедитесь, что вы в ALT:V (не в браузере)
2. Проверьте, что интерьер установлен
3. Проверьте консоль на наличие ошибок

### Скачивание зависло

1. Проверьте соединение с backend
2. Убедитесь, что токен авторизации валиден
3. Проверьте логи сервера ALT:V

---

## 📊 Статистика

Получить статистику по интерьерам:

```bash
GET https://hub.feeld.space/api/rpf/mlo/stats
```

Ответ:
```json
{
  "success": true,
  "stats": {
    "total_interiors": 150,
    "total_archives": 45,
    "avg_per_archive": 3.33
  }
}
```

---

## 🔄 Workflow

```
┌─────────────────────┐
│ Загрузка архива     │
└──────────┬──────────┘
           │
           v
┌─────────────────────┐
│ Индексация          │
│ (Unpacker)          │
└──────────┬──────────┘
           │
           v
┌─────────────────────┐
│ Сканирование YMAP   │
│ на CMloInstanceDef  │
└──────────┬──────────┘
           │
           v
┌─────────────────────┐
│ Сохранение в БД     │
│ (rpf_interiors)     │
└──────────┬──────────┘
           │
           v
┌─────────────────────┐
│ Отображение в UI    │
│ (InteriorsPage)     │
└──────────┬──────────┘
           │
           v
┌─────────────────────┐
│ Скачивание +        │
│ Телепортация        │
└─────────────────────┘
```

---

## 📝 Примечания

- Интерьеры определяются ТОЛЬКО по типу `CMloInstanceDef` в YMAP
- Обычные объекты (CEntityDef) НЕ считаются интерьерами
- Координаты берутся напрямую из YMAP без преобразований
- Ротация хранится в формате кватерниона (x, y, z, w)

---

## 🎯 Следующие шаги

- [ ] Добавить базовые интерьеры GTA V (вкладка GTAV)
- [ ] Добавить сканирование локальных интерьеров (вкладка Local)
- [ ] Добавить превью/скриншоты интерьеров
- [ ] Добавить категории и фильтры
- [ ] Добавить поиск по интерьерам
- [ ] Добавить экспорт списка интерьеров

---

## 📞 Поддержка

При возникновении проблем проверьте:
1. Логи backend (`/app/logs/`)
2. Логи ALT:V сервера
3. Консоль браузера (F12)
4. Таблицу `rpf_interiors` в БД
